server {
    listen 8080 default_server;
    listen [::]:8080 default_server;
    server_name _;
    
    root /home/site/wwwroot;
    index index.html;

    # ============================================
    # 1. API ENDPOINTS (PHP files in api directories)
    # ============================================
    # Matches: /api/login.php, /doctor_api/appointments/get-today.php, etc.
    location ~ ^/(api|admin_api|doctor_api)/.+\.php$ {
        root /home/site/wwwroot;
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }

    # ============================================
    # 2. PATIENT API (standalone PHP file)
    # ============================================
    # Matches: /patient_api.php
    location ~ ^/patient_api\.php {
        root /home/site/wwwroot;
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }

    # ============================================
    # 3. ANY OTHER PHP FILES (root level)
    # ============================================
    # Matches: /anything.php in the root directory
    location ~ \.php$ {
        root /home/site/wwwroot;
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }

    # ============================================
    # 4. STATIC FILES (JS, CSS, images)
    # ============================================
    # Matches: /assets/index-ABC123.js, /logo.jpg, etc.
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot|map)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # ============================================
    # 5. REACT APP (everything else)
    # ============================================
    # Matches: /, /login, /dashboard, /any-route
    # All unknown routes go to index.html (React handles routing)
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
}
```

## Request Flow Examples:

### Example 1: User visits `/login`
```
1. Browser requests: https://your-app.com/login
2. NGINX checks: Is it a PHP file? NO
3. NGINX checks: Is it a static file? NO
4. NGINX falls through to location /
5. try_files checks: Does /login exist? NO
6. try_files checks: Does /login/ exist? NO
7. try_files serves: /index.html ✅
8. React app loads and handles /login route
```

### Example 2: User calls API `/api/login.php`
```
1. Browser requests: https://your-app.com/api/login.php
2. NGINX checks: Matches ^/(api|admin_api|doctor_api)/.+\.php$ ✅
3. NGINX forwards to: PHP-FPM at 127.0.0.1:9000
4. PHP-FPM executes: /home/site/wwwroot/api/login.php
5. Returns: JSON response
```

### Example 3: React loads JavaScript
```
1. Browser requests: https://your-app.com/assets/index-ABC123.js
2. NGINX checks: Matches \.js$ ✅
3. NGINX serves: /home/site/wwwroot/assets/index-ABC123.js
4. Returns: JavaScript file with 1-year cache
```

### Example 4: Nested API endpoint
```
1. Browser requests: https://your-app.com/doctor_api/appointments/get-today.php
2. NGINX checks: Matches ^/(api|admin_api|doctor_api)/.+\.php$ ✅
3. NGINX forwards to: PHP-FPM
4. PHP-FPM executes: /home/site/wwwroot/doctor_api/appointments/get-today.php
5. Returns: JSON response